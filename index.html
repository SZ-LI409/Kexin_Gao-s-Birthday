<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kexin Gao's 22nd Birthday</title>
    
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Oswald:wght@300;400;500&family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Roboto+Mono:wght@300;500&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #d4af37;
            --bright-gold: #f9d77e;
            --dark-gold: #8a7020;
            --black: #080808;
            --screen-bg: #051005;
        }

        body {
            background-color: var(--black);
            color: var(--gold);
            font-family: 'Oswald', sans-serif;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            padding-top: 40px;
            padding-bottom: 80px;
            min-height: 100vh;
            touch-action: pan-y;
            overflow-y: auto;
            box-sizing: border-box;
            overflow-x: hidden;
        }

        /* Logo 区域 */
        .logo-container { margin-bottom: 25px; width: 55%; max-width: 240px; display: flex; justify-content: center; flex-shrink: 0; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.8)); }
        .logo-container img { width: 100%; height: auto; display: block; }

        /* 示波器 */
        #screen-frame {
            width: 88vw; height: 280px; max-height: 35vh;
            border: 6px solid #2a2a2a; border-radius: 16px; background: var(--screen-bg);
            position: relative; margin-bottom: 20px; overflow: hidden; flex-shrink: 0; z-index: 10;
            box-shadow: inset 0 0 60px rgba(0,0,0,0.9), 0 0 0 2px var(--dark-gold), 0 10px 20px rgba(0,0,0,0.5);
        }
        #screen-frame::after {
            content: " "; display: block; position: absolute; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 2; background-size: 100% 2px, 3px 100%; pointer-events: none;
        }
        canvas { width: 100%; height: 100%; }

        .controls { width: 82vw; display: flex; flex-direction: column; gap: 35px; flex-shrink: 0; z-index: 10; }
        .slider-group { position: relative; }
        .label { font-size: 0.9rem; letter-spacing: 3px; color: #666; margin-bottom: 12px; display: block; font-weight: 400; text-transform: uppercase; }
        input[type=range] { width: 100%; -webkit-appearance: none; height: 10px; border-radius: 5px; outline: none; background: #111; box-shadow: inset 0 2px 5px rgba(0,0,0,0.8), 0 1px 0 rgba(255,255,255,0.1); }
        #freq { background: linear-gradient(to right, #111 10%, var(--dark-gold) 11%, var(--gold) 11.5%, var(--dark-gold) 12%, #111 13%); }
        #amp { background: linear-gradient(to right, #111 79%, var(--dark-gold) 80%, var(--gold) 80.5%, var(--dark-gold) 81%, #111 82%); }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 36px; width: 36px; border-radius: 50%; background: repeating-radial-gradient(#ddd, #ddd 1px, var(--gold) 2px, var(--dark-gold) 4px); border: 2px solid #000; box-shadow: 0 6px 12px rgba(0,0,0,0.7); cursor: pointer; margin-top: -13px; position: relative; z-index: 10; }

        /* 示波器遮罩 */
        #screen-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); flex-direction: column; align-items: center; justify-content: center; z-index: 5; text-align: center; display: flex; opacity: 0; pointer-events: none; transition: opacity 1s ease-in-out; cursor: pointer; }
        #screen-overlay.visible { opacity: 1; pointer-events: auto; }
        .success-title { color: #fff; font-family: 'Great Vibes', cursive; font-size: 13vw; line-height: 1.2; margin: 0; text-shadow: 0 0 20px var(--gold); padding: 0 10px; }
        .date-display { font-family: 'Roboto Mono', monospace; color: var(--gold); font-size: 0.9rem; margin-top: 10px; letter-spacing: 1px; border-top: 1px solid #333; border-bottom: 1px solid #333; padding: 5px 10px; opacity: 0.8; }
        #tap-hint { font-family: 'Roboto Mono', monospace; font-size: 12px; color: var(--bright-gold); margin-top: 30px; opacity: 0; transition: opacity 0.5s; letter-spacing: 1px; border: 1px solid var(--gold); padding: 10px 20px; background: rgba(0,0,0,0.8); border-radius: 2px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(212, 175, 55, 0); } 100% { box-shadow: 0 0 0 0 rgba(212, 175, 55, 0); } }

        /* Review Button */
        .review-btn-container { height: 40px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; }
        .review-btn { background: transparent; border: 1px solid var(--gold); color: var(--gold); font-family: 'Oswald', sans-serif; font-size: 0.9rem; letter-spacing: 2px; padding: 10px 24px; border-radius: 2px; cursor: pointer; text-transform: uppercase; opacity: 0; pointer-events: none; transition: all 0.6s ease; box-shadow: 0 0 15px rgba(212, 175, 55, 0.1); transform: translateY(10px); }
        .review-btn.visible { opacity: 1; pointer-events: auto; transform: translateY(0); }
        .review-btn:active { background: rgba(212, 175, 55, 0.2); }

        /* Lightbox */
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 3000; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; backdrop-filter: blur(5px); }
        #lightbox.visible { opacity: 1; pointer-events: auto; }
        #lightbox-img { max-width: 90vw; max-height: 80vh; border: 12px solid #fff; box-shadow: 0 0 50px rgba(0,0,0,0.8); border-bottom-width: 40px; transform: scale(0.9); transition: transform 0.3s ease; }
        #lightbox.visible #lightbox-img { transform: scale(1); }
        .lightbox-close { position: absolute; bottom: 30px; color: #fff; font-family: 'Roboto Mono', monospace; font-size: 12px; opacity: 0.7; letter-spacing: 2px; }

        /* 信件图层 */
        #letter-layer { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 5, 5, 0.95); backdrop-filter: blur(10px); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: opacity 0.8s ease; padding: 20px; box-sizing: border-box; }
        #letter-layer.show { opacity: 1; pointer-events: auto; }
        .letter-card { border: 2px solid transparent; border-image: linear-gradient(135deg, var(--dark-gold), var(--bright-gold), var(--dark-gold)) 1; padding: 40px 30px; max-width: 340px; width: 100%; background: linear-gradient(180deg, #111, #080808); box-shadow: 0 0 50px rgba(212, 175, 55, 0.15); text-align: center; position: relative; transform: scale(0.95) translateY(20px); transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1); overflow: visible; }
        #letter-layer.show .letter-card { transform: scale(1) translateY(0); }
        .card-header { font-family: 'Cinzel', serif; color: var(--gold); font-size: 0.8rem; letter-spacing: 4px; margin-bottom: 25px; border-bottom: 1px solid #333; padding-bottom: 15px; text-transform: uppercase; }
        .card-title { font-family: 'Great Vibes', cursive; font-size: 2.5rem; color: #fff; margin: 0 0 20px 0; line-height: 1.2; background: linear-gradient(to right, #fff, var(--bright-gold), #fff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; min-height: 3rem; }
        .letter-text { font-family: 'Oswald', sans-serif; font-size: 1.1rem; color: #ccc; line-height: 1.8; white-space: pre-line; margin-bottom: 30px; font-weight: 300; letter-spacing: 1px; min-height: 120px; position: relative; z-index: 2; }
        .close-hint { font-family: 'Roboto Mono', monospace; font-size: 11px; color: #555; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; transition: color 0.3s; margin-top: 10px; display: inline-block; border-bottom: 1px solid transparent; position: relative; z-index: 100; }
        .close-hint:hover { color: var(--gold); border-color: var(--gold); }

        .polaroid { position: absolute; background: #fff; padding: 6px 6px 20px 6px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); z-index: 50; opacity: 0; width: 90px; top: -60vh; left: 50%; cursor: zoom-in; pointer-events: auto; transition: transform 0.3s ease; }
        .polaroid img { width: 100%; display: block; filter: sepia(20%); }
        @keyframes dropIn { 0% { top: -60vh; opacity: 0; transform: rotate(0deg); } 100% { top: var(--target-top); opacity: 1; transform: rotate(var(--target-rot)); } }
        .polaroid.drop { animation: dropIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .special-btn { background: var(--gold); color: #000; border: none; padding: 12px 30px; font-family: 'Oswald', sans-serif; font-size: 1rem; text-transform: uppercase; letter-spacing: 2px; cursor: pointer; border-radius: 4px; box-shadow: 0 0 20px rgba(212,175,55,0.4); margin-bottom: 15px; display: none; position: relative; z-index: 101; }
        .special-btn.show { display: inline-block; animation: popIn 0.5s ease; }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* === 音乐播放器层 === */
        #music-player-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 10, 10, 0.98); z-index: 5000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: opacity 0.8s ease;
        }
        #music-player-layer.active { opacity: 1; pointer-events: auto; }

        .player-container {
            width: 90%; max-width: 700px; height: 320px;
            background: linear-gradient(135deg, #1a1a1a 0%, #0d0d0d 100%);
            border: 1px solid #333; border-radius: 12px;
            display: flex; overflow: hidden;
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            position: relative;
            transition: all 0.5s ease; /* 适配横竖屏切换动画 */
        }

        .player-exit {
            position: absolute; top: 15px; left: 15px;
            color: #666; font-size: 24px; cursor: pointer; z-index: 20;
            width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
            border: 1px solid #333; border-radius: 50%; transition: all 0.3s; background: rgba(0,0,0,0.5);
        }
        .player-exit:hover { color: var(--gold); border-color: var(--gold); background: #000; }

        .player-cover {
            width: 320px; height: 100%; flex-shrink: 0;
            position: relative; border-right: 1px solid #222;
            cursor: pointer;
        }
        .player-cover img { 
            width: 100%; height: 100%; object-fit: cover; 
            opacity: 1; transition: transform 0.3s; 
        }
        .player-cover:hover img { opacity: 1; transform: scale(1.02); }
        
        /* 播放/暂停 大图标 */
        .play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }
        .play-icon {
            width: 60px; height: 60px; fill: #fff; opacity: 0; transition: opacity 0.3s, transform 0.2s;
            filter: drop-shadow(0 0 10px rgba(0,0,0,0.5));
        }
        .player-cover.paused .play-icon { opacity: 0.8; }
        .player-cover:active .play-icon { transform: scale(0.9); }

        .player-info {
            flex-grow: 1; padding: 30px; display: flex; flex-direction: column;
            position: relative;
        }

        .song-title { color: #fff; font-family: 'Oswald', sans-serif; font-size: 1.8rem; margin: 0; letter-spacing: 1px; }
        .artist-name { color: var(--gold); font-family: 'Roboto Mono', monospace; font-size: 0.9rem; margin-top: 5px; opacity: 0.8; }

        /* 歌词容器 */
        .lyrics-container {
            margin-top: 20px; flex-grow: 1; 
            position: relative;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            overflow: hidden;
        }

        .lyric-line {
            color: #555; text-align: center; padding: 8px 0; 
            font-family: 'Roboto Mono', sans-serif; font-size: 0.95rem; 
            transition: all 0.5s ease-out;
            opacity: 0.4; line-height: 1.4;
            width: 90%; white-space: normal; min-height: 1.4em;
        }
        .lyric-line.active { 
            color: #fff; font-size: 1.2rem; font-weight: 500;
            text-shadow: 0 0 15px rgba(212, 175, 55, 0.3); 
            opacity: 1; transform: scale(1.05);
        }

        /* --- 迷你悬浮窗 (Mini Player) --- */
        #mini-player {
            position: fixed; bottom: 20px; right: 20px;
            width: 60px; height: 60px;
            border-radius: 50%;
            background: #111;
            border: 2px solid var(--gold);
            box-shadow: 0 5px 20px rgba(0,0,0,0.8);
            z-index: 100;
            display: none;
            align-items: center; justify-content: center;
            cursor: pointer;
            overflow: hidden;
            transition: transform 0.3s;
        }
        #mini-player.visible { display: flex; animation: floatIn 0.5s ease-out; }
        #mini-player:hover { transform: scale(1.1); }
        
        .mini-disc {
            width: 100%; height: 100%;
            background: url('marshall.png') no-repeat center/cover;
            border-radius: 50%;
            opacity: 0.8;
            animation: spin 8s linear infinite;
        }
        .mini-disc.paused { animation-play-state: paused; }
        
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes floatIn { from { transform: translateY(100px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* 移动端竖屏适配 */
        @media (max-width: 600px) and (orientation: portrait) {
            .player-container { flex-direction: column; height: 85vh; width: 85vw; }
            .player-cover { width: 100%; height: 40%; border-right: none; border-bottom: 1px solid #222; }
            .player-info { height: 60%; padding: 20px 15px; }
            .song-title { font-size: 1.5rem; }
            .lyric-line { font-size: 0.9rem; padding: 6px 0; }
            .lyric-line.active { font-size: 1.15rem; }
        }

        /* 横屏适配 */
        @media (orientation: landscape) {
            .player-container { width: 100vw; height: 100vh; max-width: none; border-radius: 0; border: none; }
            .player-cover { width: 45%; }
            .player-info { width: 55%; padding: 40px; }
            .song-title { font-size: 2.5rem; }
            .lyric-line { font-size: 1.1rem; }
            .lyric-line.active { font-size: 1.4rem; }
        }

    </style>
</head>
<body>

    <div class="logo-container">
        <img src="marshall.png" alt="Marshall">
    </div>

    <div id="screen-frame">
        <canvas id="osc"></canvas>
        <div id="screen-overlay">
            <h1 class="success-title">Happy Birthday</h1>
            <div class="date-display">2004.01.29 - 2026.01.29</div>
            <div id="tap-hint">CLICK TO START</div>
        </div>
    </div>

    <div class="review-btn-container">
        <button id="reviewBtn" class="review-btn">Read Wish Again</button>
    </div>

    <div id="lightbox">
        <img id="lightbox-img" src="" alt="Zoomed Photo">
        <div class="lightbox-close">Tap anywhere to close</div>
    </div>

    <div id="letter-layer">
        <div class="letter-card" id="letterCard">
            <div class="card-header">BUZHIDAOXIESHENME</div>
            <h2 class="card-title" id="cardTitle">Happy Birthday</h2>
            <p class="letter-text" id="cardText"></p>
            <button id="musicStartBtn" class="special-btn">Listen Now</button>
            <div id="polaroid-container">
                <div class="polaroid" id="p1" style="--target-top: -50px; --target-rot: -12deg; left: -5px;"><img src="sea.png" alt="Sea"></div>
                <div class="polaroid" id="p2" style="--target-top: -50px; --target-rot: 10deg; left: auto; right: 5px;"><img src="japan.png" alt="Japan"></div>
                <div class="polaroid" id="p3" style="--target-top: 75%; --target-rot: -5deg; left: auto; right: 10px;"><img src="snow.png" alt="Snow"></div>
            </div>
            <div class="close-hint" id="closeLetterBtn">Tap anywhere to close</div>
        </div>
    </div>

    <div id="music-player-layer">
        <div class="player-container">
            <div class="player-exit" id="playerExitBtn">✕</div>
            <div class="player-cover" id="playerCover">
                <img src="marshall.png" alt="Album Cover">
                <div class="vinyl-effect"></div>
                <div class="play-overlay">
                    <svg class="play-icon" viewBox="0 0 24 24">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                </div>
            </div>
            <div class="player-info">
                <h3 class="song-title">二十二</h3>
                <p class="artist-name">Shengzhen Li & Artificial Intelligence</p>
                <div class="lyrics-container" id="lyricsContainer"></div>
            </div>
        </div>
    </div>

    <div id="mini-player">
        <div class="mini-disc" id="miniDisc"></div>
    </div>

    <div class="controls">
        <div class="slider-group"><span class="label">Frequency</span><input type="range" id="freq" min="0" max="100" value="45"></div>
        <div class="slider-group"><span class="label">Amplitude</span><input type="range" id="amp" min="0" max="100" value="30"></div>
    </div>

    <audio id="bgm" preload="auto" loop>
        <source src="birthday.mp3" type="audio/mpeg">
    </audio>

    <script>
        const lrcContent = `[00:00.00]二十二 
[00:02.00]词：陶喆/娃娃
[00:03.00]
[00:03.00]曲：陶喆
[00:04.00]
[00:04.00]编曲：陶喆
[00:05.00]
[00:05.00]瞎改：李升臻
[00:06.00]
[00:06.00]To：Kexin  
[00:37.00]春天是她最爱的季节
[00:41.24]当微风随意吹乱她的头发
[00:46.21]她并不在意身边世界的吵杂
[00:51.16]只想着自己生命中的变化
[00:57.42]还有十五分钟才午休
[01:02.28]从早到晚没有想象中那么好过
[01:07.17]安定的日子不一定就是幸福
[01:12.42]忘不掉她在心里做过的梦
[01:18.40]她今年农历三月六号刚满二十二
[01:23.31]刚甩开课本要离开家看看这世界
[01:28.23]却发现许多烦恼要面对
[01:39.23]她常会向往能回到那年她一十二
[01:44.44]只需要好好上学 生活单纯没忧愁
[01:49.27]她就像一朵蓓蕾 满怀希望
[02:00.58]秋天是忽然间就来临
[02:04.42]青春虽然有本钱可以洒脱
[02:09.47]一场恋爱二十二个月后结束
[02:14.52]才知道有些感情不值得赌
[02:20.52]九月天气还是有点热
[02:25.04]她想公车再不来就走一走路
[02:30.07]她开始明白等待未必有结果
[02:35.13]一个人也能走上梦的旅途
[02:41.08]她今年农历三月六号刚满二十二
[02:46.04]刚甩开课本要离开家看看这世界
[02:50.65]却发现许多烦恼要面对
[03:01.53]她常会向往能回到那年她一十二
[03:06.63]只需要好好上学 生活单纯没忧愁
[03:11.12]她一直满怀希望
[03:16.83]人生偶尔会走上一条陌路
[03:21.94]像是没有指标的地图
[03:26.78]别让她们说你该知足
[03:31.73]只有你知道什么是你的幸福
[03:57.38]她常会向往能回到那年她一十二
[04:02.24]只需要好好上学生活单纯没忧愁
[04:07.37]她笑着想过未来
[04:11.81]她应该得到幸福
[04:14.92]如此的简单的梦
[04:22.12]有没有实现
`;

        const canvas = document.getElementById('osc');
        const ctx = canvas.getContext('2d');
        const freqInput = document.getElementById('freq');
        const ampInput = document.getElementById('amp');
        const screenOverlay = document.getElementById('screen-overlay');
        const bgm = document.getElementById('bgm');
        const tapHint = document.getElementById('tap-hint');
        const letterLayer = document.getElementById('letter-layer');
        const reviewBtn = document.getElementById('reviewBtn');
        const cardTitle = document.getElementById('cardTitle');
        const cardText = document.getElementById('cardText');
        const closeLetterBtn = document.getElementById('closeLetterBtn');
        const polaroids = document.querySelectorAll('.polaroid');
        const lightbox = document.getElementById('lightbox');
        const lightboxImg = document.getElementById('lightbox-img');
        const musicStartBtn = document.getElementById('musicStartBtn');
        const musicPlayerLayer = document.getElementById('music-player-layer');
        const playerExitBtn = document.getElementById('playerExitBtn');
        const lyricsContainer = document.getElementById('lyricsContainer');
        const playerCover = document.getElementById('playerCover');
        const miniPlayer = document.getElementById('mini-player');
        const miniDisc = document.getElementById('miniDisc');

        let width, height, offset = 0;
        let isUnlocked = false;
        let clickCount = 0;
        let hasOpenedPlayer = false; 
        let lyricsData = []; 

        class SoundFX {
            constructor() { this.ctx = null; this.isPlaying = false; }
            init() {
                if (this.ctx) return;
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                const bufferSize = this.ctx.sampleRate * 2;
                this.noiseBuffer = this.ctx.createBuffer(1, bufferSize, this.ctx.sampleRate);
                const data = this.noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
            }
            start() {
                if (this.isPlaying || !this.ctx) return;
                this.noiseNode = this.ctx.createBufferSource();
                this.noiseNode.buffer = this.noiseBuffer;
                this.noiseNode.loop = true;
                this.gainNode = this.ctx.createGain();
                this.gainNode.gain.value = 0;
                this.noiseNode.connect(this.gainNode);
                this.gainNode.connect(this.ctx.destination);
                this.noiseNode.start();
                this.isPlaying = true;
            }
            setVolume(val) { if (this.gainNode) this.gainNode.gain.setTargetAtTime(val * 0.05, this.ctx.currentTime, 0.1); }
            stop() { if (this.noiseNode) { this.noiseNode.stop(); this.isPlaying = false; } }
        }
        const sfx = new SoundFX();
        document.addEventListener('touchstart', () => sfx.init(), {once:true});
        document.addEventListener('click', () => sfx.init(), {once:true});

        function parseLrc(lrc) {
            const lines = lrc.split('\n');
            const result = [];
            const timeReg = /\[(\d{2}):(\d{2})\.(\d{2,3})\]/;
            lines.forEach(line => {
                const match = timeReg.exec(line);
                if (match) {
                    const min = parseInt(match[1]);
                    const sec = parseInt(match[2]);
                    const ms = parseInt(match[3]);
                    const time = min * 60 + sec + ms / 100;
                    const text = line.replace(timeReg, '').trim();
                    result.push({ time, text: text || " " }); 
                }
            });
            return result;
        }

        function initLyricsData() { lyricsData = parseLrc(lrcContent); }

        function syncLyrics() {
            if (!hasOpenedPlayer) return;
            const currentTime = bgm.currentTime;
            let activeIndex = -1;
            for (let i = 0; i < lyricsData.length; i++) {
                if (currentTime >= lyricsData[i].time) activeIndex = i;
                else break;
            }

            const prevP = document.getElementById('lyric-prev');
            const currP = document.getElementById('lyric-curr');
            const nextP = document.getElementById('lyric-next');

            if (!prevP) {
                lyricsContainer.innerHTML = '';
                const p1 = document.createElement('div'); p1.id = 'lyric-prev'; p1.className = 'lyric-line';
                const p2 = document.createElement('div'); p2.id = 'lyric-curr'; p2.className = 'lyric-line active';
                const p3 = document.createElement('div'); p3.id = 'lyric-next'; p3.className = 'lyric-line';
                lyricsContainer.appendChild(p1); lyricsContainer.appendChild(p2); lyricsContainer.appendChild(p3);
                return;
            }

            if (activeIndex !== -1) {
                prevP.innerText = (activeIndex > 0) ? lyricsData[activeIndex - 1].text : "";
                currP.innerText = lyricsData[activeIndex].text;
                nextP.innerText = (activeIndex < lyricsData.length - 1) ? lyricsData[activeIndex + 1].text : "";
            } else {
                prevP.innerText = "";
                currP.innerText = lyricsData[0] ? lyricsData[0].text : "Ready...";
                nextP.innerText = lyricsData[1] ? lyricsData[1].text : "";
            }
        }

        const contentNormal = { title: "Happy Birthday", text: "想说的话好多好多好多\n但是嘴太笨了，不如用这种方式\n\有点老土，希望你喜欢\n可欣，22岁生日快乐\n\n——Lily" };
        const contentTease = { title: "Surprise?", text: "还要？\n你也太贪了\n\n这回真没有了\n( ˘•ω•˘ )" };
        const contentMusicOffer = { title: "One More Thing", text: "还想要惊喜？\n好吧，满足你\n请欣赏我精心改编的音乐\n配合Marshall音箱（很重要）" };

        function resize() { width = canvas.width = canvas.offsetWidth; height = canvas.height = canvas.offsetHeight; }
        window.addEventListener('resize', resize); resize();

        const handleInput = () => {
            if (isUnlocked) return;
            if (!sfx.isPlaying) sfx.start();
            
            if (sfx.ctx && sfx.ctx.state === 'suspended') {
                sfx.ctx.resume();
            }

            sfx.setVolume(0.5 + Math.random() * 0.5);
            checkUnlock();
        };
        const handleStop = () => { if (isUnlocked) sfx.stop(); else sfx.setVolume(0); };
        freqInput.addEventListener('input', handleInput); ampInput.addEventListener('input', handleInput);
        freqInput.addEventListener('change', handleStop); ampInput.addEventListener('touchend', handleStop);

        function checkUnlock() {
            if (isUnlocked) return; 
            const f = parseInt(freqInput.value); const a = parseInt(ampInput.value);
            const matched = (Math.abs(f - 11) <= 4 && Math.abs(a - 80) <= 4);
            if (matched) unlockAndPlay();
        }

        function unlockAndPlay() {
            isUnlocked = true; 
            sfx.stop(); 
            tapHint.style.opacity = 1; 
            if (navigator.vibrate) navigator.vibrate([50, 50, 50]);
            setTimeout(() => screenOverlay.classList.add('visible'), 300);
        }

        function showLetter(type) {
            tapHint.style.display = 'none'; musicStartBtn.classList.remove('show');
            if (type === 'normal') { cardTitle.innerText = contentNormal.title; cardText.innerText = contentNormal.text; dropPhotos(); }
            else if (type === 'tease') { cardTitle.innerText = contentTease.title; cardText.innerText = contentTease.text; resetPhotos(); }
            else if (type === 'music_offer') { cardTitle.innerText = contentMusicOffer.title; cardText.innerText = contentMusicOffer.text; resetPhotos(); musicStartBtn.classList.add('show'); }
            letterLayer.classList.add('show');
        }

        reviewBtn.addEventListener('click', () => {
            clickCount++;
            if (clickCount === 1 && !hasOpenedPlayer) { showLetter('music_offer'); }
            else {
                let effectiveCount = hasOpenedPlayer ? clickCount + 1 : clickCount; 
                if (effectiveCount % 2 === 0) showLetter('normal'); else showLetter('tease');
            }
        });

        musicStartBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            hasOpenedPlayer = true;
            letterLayer.classList.remove('show');
            bgm.pause();
            bgm.src = "ershier_Remix.mp3"; 
            initLyricsData(); 
            bgm.load();
            bgm.play().then(() => {
                playerCover.classList.remove('paused');
                miniDisc.classList.remove('paused');
            });
            musicPlayerLayer.classList.add('active');
            syncLyrics();
        });

        bgm.addEventListener('timeupdate', syncLyrics);

        function togglePlay() {
            if (bgm.paused) {
                bgm.play();
                playerCover.classList.remove('paused');
                miniDisc.classList.remove('paused');
            } else {
                bgm.pause();
                playerCover.classList.add('paused');
                miniDisc.classList.add('paused');
            }
        }
        playerCover.addEventListener('click', togglePlay);

        playerExitBtn.addEventListener('click', () => {
            musicPlayerLayer.classList.remove('active');
            if (!reviewBtn.classList.contains('visible')) reviewBtn.classList.add('visible');
            miniPlayer.classList.add('visible');
        });

        // 【修改点 1】：miniPlayer 点击逻辑增强
        // 如果用户是第一次通过 miniPlayer 打开（之前没点 Listen Now），需要执行初始化
        miniPlayer.addEventListener('click', () => {
            // 如果从未打开过播放器，说明用户之前关掉了 Music Offer，现在通过悬浮窗进来
            if (!hasOpenedPlayer) {
                hasOpenedPlayer = true;
                bgm.src = "ershier_Remix.mp3"; 
                initLyricsData(); 
                bgm.load();
                bgm.play().then(() => {
                    playerCover.classList.remove('paused');
                    miniDisc.classList.remove('paused');
                }).catch(e => console.log(e));
                syncLyrics();
            }

            musicPlayerLayer.classList.add('active');
            miniPlayer.classList.remove('visible');
        });

        function dropPhotos() { resetPhotos(); setTimeout(() => document.getElementById('p1').classList.add('drop'), 400); setTimeout(() => document.getElementById('p2').classList.add('drop'), 800); setTimeout(() => document.getElementById('p3').classList.add('drop'), 1200); }
        function resetPhotos() { polaroids.forEach(p => { p.classList.remove('drop'); p.classList.remove('expanded'); }); document.getElementById('lightbox').classList.remove('visible'); }
        
        // 【修改点 2】：hideLetter 逻辑增强
        // 当关闭信件时，如果发现刚才显示的是“Music Offer”（即带有 musicStartBtn 的信），强制显示 miniPlayer
        function hideLetter() { 
            // 检查：如果当前信件里有“Listen Now”按钮（说明是第三封信），且用户点击了关闭
            if (musicStartBtn.classList.contains('show')) {
                miniPlayer.classList.add('visible');
            }

            letterLayer.classList.remove('show'); 
            resetPhotos(); 
            if (!reviewBtn.classList.contains('visible')) setTimeout(() => reviewBtn.classList.add('visible'), 500); 
        }
        
        polaroids.forEach(p => p.addEventListener('click', (e) => { e.stopPropagation(); lightboxImg.src = p.querySelector('img').src; lightbox.classList.add('visible'); }));
        lightbox.addEventListener('click', () => lightbox.classList.remove('visible'));
        letterLayer.addEventListener('click', (e) => { if (!e.target.closest('.polaroid') && !e.target.closest('.special-btn')) hideLetter(); });
        
        function manualPlay() { 
            bgm.play().catch(e => console.log("Audio play error:", e));
            showLetter('normal'); 
        }

        tapHint.addEventListener('click', manualPlay);
        screenOverlay.addEventListener('click', manualPlay);

        function draw() {
            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = 'rgba(212, 175, 55, 0.1)'; ctx.lineWidth = 1;
            for(let i=0; i<width; i+=40) { ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, height); ctx.stroke(); }
            for(let i=0; i<height; i+=40) { ctx.beginPath(); ctx.moveTo(0, i); ctx.lineTo(width, i); ctx.stroke(); }
            const f = parseInt(freqInput.value); const a = parseInt(ampInput.value);
            const matched = (Math.abs(f - 11) <= 4 && Math.abs(a - 80) <= 4);
            ctx.strokeStyle = matched ? '#00ff00' : '#d4af37'; ctx.lineWidth = matched ? 5 : 3;
            ctx.shadowBlur = matched ? 20 : 5; ctx.shadowColor = matched ? '#00ff00' : '#d4af37';
            ctx.beginPath();
            for (let x = 0; x < width; x++) {
                let noise = isUnlocked ? 0 : (Math.random() - 0.5) * (30 - a/4);
                let y = height/2 + Math.sin(x * (f/150) + offset) * (a * height/300) + noise;
                if (x === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
            }
            ctx.stroke();
            offset += isUnlocked ? 0.15 : 0.08;
            requestAnimationFrame(draw);
        }
        draw();
    </script>
</body>
</html>
